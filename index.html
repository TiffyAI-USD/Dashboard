<!DOCTYPE html>
<html>
<head>
    <title>OS Admin Panel</title>
    <style>
        :root { --accent: #00d4ff; --bg: #000; --text: #00ff00; --banned: #ff4444; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .broadcast-box { background: #111; padding: 20px; border: 1px solid #333; border-radius: 12px; margin-bottom: 25px; }
        textarea { width: 100%; height: 80px; background: #222; color: #fff; border: 1px solid #444; padding: 10px; margin-top: 10px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; background: #0a0a0a; }
        th, td { border: 1px solid #222; padding: 12px; text-align: left; }
        th { background: #151515; }
        button { cursor: pointer; font-weight: bold; border: none; padding: 6px 12px; border-radius: 4px; transition: 0.2s; }
        .btn-view { background: var(--accent); color: #000; }
        .btn-ban { background: var(--banned); color: #fff; }
        .btn-wa { background: #25d366; color: white; margin-top: 10px; padding: 12px 24px; }
        tr:hover { background: #111; }
    </style>
</head>
<body>
    <h1>üõ∞Ô∏è Global Store Manager</h1>
    <div class="broadcast-box">
        <h3>üì¢ WhatsApp Broadcast</h3>
        <textarea id="broadcastMsg" placeholder="Type message..."></textarea>
        <button class="btn-wa" onclick="sendBroadcast()">üöÄ Send to Selected</button>
    </div>
    <div id="stats">Loading...</div>
    <table>
        <thead>
            <tr>
                <th><input type="checkbox" onclick="toggleAll(this)"></th>
                <th>Store / Owner</th>
                <th>Trial / Created</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
    <script>
        const API = 'https://webstore-api-m8sr.onrender.com';
        async function load() {
            const res = await fetch(`${API}/api/admin/all-stores`);
            const stores = await res.json();
            document.getElementById('stats').innerText = `Total: ${stores.length}`;
            document.getElementById('tableBody').innerHTML = stores.map(s => {
                const diff = Math.ceil((new Date(s.trial_expires) - new Date()) / (1000*60*60*24));
                return `
                <tr>
                    <td><input type="checkbox" class="store-check" value="${s.owner_whatsapp}"></td>
                    <td><b>${s.handle}</b><br><small style="color:#888">${s.name || 'Unnamed'}</small></td>
                    <td><small style="color:${diff <= 2 ? 'red' : '#ffae00'}">${diff}d left</small><br><small style="color:#555">${new Date(s.created_at).toLocaleDateString()}</small></td>
                    <td style="color:${s.is_active ? '#0ff' : 'red'}">${s.is_active ? 'LIVE' : 'BANNED'}</td>
                    <td>
                        <button class="btn-view" onclick="window.open('${API}/view/${s.handle}')">VIEW</button>
                        <button class="${s.is_active ? 'btn-ban' : 'btn-wa'}" onclick="action('${s.handle}','toggle')">${s.is_active ? 'BAN' : 'ACTIVATE'}</button>
                        <button style="background:#ffae00" onclick="action('${s.handle}','extend')">+30D</button>
                    </td>
                </tr>`;
            }).join('');
        }
        function toggleAll(m) { document.querySelectorAll('.store-check').forEach(c => c.checked = m.checked); }
        function sendBroadcast() {
            const msg = document.getElementById('broadcastMsg').value;
            const selected = Array.from(document.querySelectorAll('.store-check:checked')).map(c => c.value).filter(v => v && v !== 'null');
            if(!msg || selected.length === 0) return alert("Select stores & type message!");
            selected.forEach((n, i) => { setTimeout(() => window.open(`https://wa.me/${n}?text=${encodeURIComponent(msg)}`, '_blank'), i * 800); });
        }
        async function action(handle, action) {
            await fetch(`${API}/api/admin/action`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({handle, action}) });
            load();
        }
        load();
    </script>
</body>
</html>
